# Техническая спецификация
## OCR-OCD: Технический стек и архитектура

### Архитектура приложения

| Слой | Компоненты | Описание |
|------|------------|----------|
| **Представление** | CLI интерфейс | Консольное приложение с аргументами командной строки |
| **Бизнес-логика** | PDF Processor, Vision API Client, Data Extractor | Основная логика обработки документов |
| **Интеграция** | OpenAI API Client | Взаимодействие с внешними сервисами |
| **Данные** | CSV Writer, State Manager | Сохранение результатов и состояния |
| **Инфраструктура** | Logger, Config Manager | Логирование и конфигурация |

### Основные библиотеки и зависимости

| Библиотека | Версия | Назначение | Ссылка на документацию | Альтернативы | Обоснование выбора |
|------------|--------|------------|------------------------|--------------|-------------------|
| **PyMuPDF (fitz)** | ^1.23.0 | Конвертация PDF в изображения | [docs](https://pymupdf.readthedocs.io/) | pdf2image, pdfplumber | Высокая производительность, качественная конвертация, встроенная обработка изображений |
| **openai** | ^1.3.0 | Интеграция с OpenAI API | [docs](https://platform.openai.com/docs) | anthropic, google-cloud-aiplatform | Официальная библиотека OpenAI, стабильная работа с GPT-4 Vision |
| **Pillow** | ^10.0.0 | Обработка изображений | [docs](https://pillow.readthedocs.io/) | opencv-python, imageio | Простота использования, достаточная функциональность для базовых операций |
| **python-dotenv** | ^1.0.0 | Загрузка переменных окружения | [docs](https://python-dotenv.readthedocs.io/) | configparser, os.environ | Стандарт де-факто для работы с .env файлами |
| **pandas** | ^2.1.0 | Обработка и экспорт CSV | [docs](https://pandas.pydata.org/) | csv (встроенный), openpyxl | Богатая функциональность для работы с табличными данными, простой экспорт в CSV |
| **tenacity** | ^8.2.0 | Retry логика для API | [docs](https://tenacity.readthedocs.io/) | retrying, backoff | Гибкая конфигурация retry-политик, декораторы |
| **click** | ^8.1.0 | CLI интерфейс | [docs](https://click.palletsprojects.com/) | argparse, typer | Простота создания CLI, автогенерация help, валидация параметров |
| **loguru** | ^0.7.0 | Логирование | [docs](https://loguru.readthedocs.io/) | logging (встроенный), structlog | Простота настройки, красивый вывод, ротация логов |
| **pydantic** | ^2.4.0 | Валидация данных | [docs](https://docs.pydantic.dev/) | marshmallow, cerberus | Type hints, автоматическая валидация, отличная интеграция с современным Python |
| **tqdm** | ^4.66.0 | Progress bar | [docs](https://tqdm.github.io/) | progressbar2, rich.progress | Минимальные зависимости, простота использования |

### Вспомогательные зависимости

| Библиотека | Версия | Назначение | Ссылка на документацию | Альтернативы | Обоснование выбора |
|------------|--------|------------|------------------------|--------------|-------------------|
| **requests** | ^2.31.0 | HTTP запросы (fallback) | [docs](https://docs.python-requests.org/) | httpx, urllib3 | Стабильность, широкое использование |
| **pathlib** | встроенная | Работа с путями файлов | [docs](https://docs.python.org/3/library/pathlib.html) | os.path | Современный объектно-ориентированный подход |
| **json** | встроенная | Сериализация данных | [docs](https://docs.python.org/3/library/json.html) | ujson, orjson | Встроенная библиотека, достаточная производительность |
| **datetime** | встроенная | Работа с датами | [docs](https://docs.python.org/3/library/datetime.html) | arrow, pendulum | Встроенная библиотека |
| **base64** | встроенная | Кодирование изображений | [docs](https://docs.python.org/3/library/base64.html) | - | Стандартная библиотека для API |

### Development зависимости

| Библиотека | Версия | Назначение | Ссылка на документацию | Альтернативы | Обоснование выбора |
|------------|--------|------------|------------------------|--------------|-------------------|
| **pytest** | ^7.4.0 | Тестирование | [docs](https://docs.pytest.org/) | unittest, nose2 | Простота написания тестов, богатая экосистема плагинов |
| **pytest-cov** | ^4.1.0 | Coverage отчёты | [docs](https://pytest-cov.readthedocs.io/) | coverage.py | Интеграция с pytest |
| **black** | ^23.9.0 | Форматирование кода | [docs](https://black.readthedocs.io/) | autopep8, yapf | Стандарт де-факто, нулевая конфигурация |
| **flake8** | ^6.0.0 | Линтер | [docs](https://flake8.pycqa.org/) | pylint, ruff | Баланс между строгостью и практичностью |
| **mypy** | ^1.5.0 | Проверка типов | [docs](https://mypy.readthedocs.io/) | pyright, pyre | Стандарт для статической типизации |

### Системные требования

| Компонент | Требования | Обоснование |
|-----------|------------|-------------|
| **Python** | 3.9+ | Поддержка современных features, type hints |
| **ОС** | Linux, macOS, Windows | Кроссплатформенность PyMuPDF и других библиотек |
| **RAM** | 2GB+ | Обработка изображений высокого разрешения |
| **Диск** | 1GB+ | Временные файлы изображений |
| **Интернет** | Стабильное соединение | API запросы к OpenAI |

### Структура проекта

| Папка/Файл | Назначение |
|------------|------------|
| `src/` | Основной код приложения |
| `src/main.py` | Точка входа в приложение |
| `src/core/` | Основная бизнес-логика |
| `src/core/pdf_processor.py` | Обработка PDF файлов |
| `src/core/vision_client.py` | Клиент для OpenAI Vision API |
| `src/core/data_extractor.py` | Извлечение и структурирование данных |
| `src/core/csv_writer.py` | Экспорт данных в CSV |
| `src/utils/` | Вспомогательные утилиты |
| `src/utils/logger.py` | Настройка логирования |
| `src/utils/config.py` | Загрузка конфигурации |
| `src/utils/state_manager.py` | Управление состоянием обработки |
| `src/models/` | Модели данных |
| `src/models/task.py` | Модель задачи |
| `src/models/page.py` | Модель страницы |
| `tests/` | Тесты |
| `tests/unit/` | Юнит-тесты |
| `tests/integration/` | Интеграционные тесты |
| `tests/fixtures/` | Тестовые данные |
| `docs/` | Документация проекта |
| `logs/` | Файлы логов |
| `output/` | Выходные CSV файлы |
| `temp/` | Временные файлы (изображения) |
| `requirements.txt` | Python зависимости |
| `.env.example` | Пример файла конфигурации |
| `pyproject.toml` | Конфигурация проекта и зависимостей |
| `README.md` | Документация пользователя |
| `.gitignore` | Игнорируемые Git файлы |

### Конфигурация API

| Параметр | Значение по умолчанию | Описание |
|----------|----------------------|----------|
| `OPENAI_API_KEY` | из .env | API ключ OpenAI |
| `MODEL_NAME` | gpt-4-vision-preview | Модель для использования |
| `MAX_TOKENS` | 4096 | Максимальное количество токенов в ответе |
| `TEMPERATURE` | 0.1 | Температура генерации (низкая для точности) |
| `TIMEOUT` | 60 | Таймаут запроса в секундах |
| `MAX_RETRIES` | 3 | Количество повторных попыток |
| `RETRY_DELAY` | 5 | Задержка между попытками в секундах |

### Форматы данных

#### Структура CSV выходного файла
```csv
page_number,task_number,task_text,has_image
1,1,"Сложи числа 2 + 3",false
1,2,"Реши пример: 5 - 2 = ?",false  
1,unknown-1,"Найди лишнее число в ряду",true
2,3,"Вычисли площадь прямоугольника",true
```

#### Формат промежуточного состояния (JSON)
```json
{
  "last_processed_page": 5,
  "total_pages": 100,
  "processed_tasks": 45,
  "errors": [],
  "timestamp": "2024-01-15T10:30:00Z"
}
```

### Производительность и ограничения

| Метрика | Ожидаемое значение | Ограничения |
|---------|-------------------|-------------|
| **Обработка страницы** | 30-60 сек | Зависит от сложности страницы и скорости API |
| **Размер PDF** | до 100 МБ | Ограничение памяти при конвертации |
| **Количество страниц** | до 500 | Практическое ограничение времени обработки |
| **Точность OCR** | 95%+ | Зависит от качества сканов |
| **Пропускная способность** | 60-120 страниц/час | Ограничения OpenAI API | 